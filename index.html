<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>App Cantina</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --vermelho:#c62828;
  --vermelho-escuro:#8e0000;
  --preto:#1e1e1e;
  --cinza:#e0e0e0;
  --cinza-claro:#f5f5f5;
}

body{
  margin:0;
  font-family:Arial, sans-serif;
  background:var(--cinza-claro);
}

.container{
  max-width:420px;
  background:white;
  margin:20px auto;
  padding:20px;
  border-radius:14px;
  box-shadow:0 6px 14px rgba(0,0,0,.15);
}

h1,h2{text-align:center}

input,button,select{
  width: 93%;
  padding:12px;
  margin-top:10px;
  border-radius:8px;
  border:1px solid var(--cinza);
  font-size:15px;
}

button{
  width:auto;
  background:var(--vermelho);
  color:white;
  font-weight:bold;
  border:none;
}

button:hover{background:var(--vermelho-escuro);cursor:pointer}
.admin{background:var(--preto)}
.admin:hover{background:black}

.btn-full {
  width: 100%;
  padding: 14px;
  font-size: 16px;
}

.hidden{display:none}

.menu{
  background:var(--cinza-claro);
  border-left:5px solid var(--vermelho);
  padding:12px;
  margin-top:10px;
  border-radius:8px;
}

.btn-back{
  background:#555;
  margin-top:15px;
}
.btn-back:hover{background:#333}

#saldo{
  text-align:center;
  font-weight:bold;
  font-size:18px;
  color:var(--vermelho);
}

.menu-dia h3 {
  background: #eee;
  padding: 10px;
  border-radius: 8px;
  margin: 0;
}

.menu-dia h3:hover {
  background: #ddd;
}

.menu-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 0;
  border-bottom: 1px solid #eee;
}

.menu-item:last-child {
  border-bottom: none;
}

.menu-item button {
  width: 50%;          /* n√£o ocupa toda a linha */
  padding: 3px 6px;     /* compacto */
  font-size: 16px;
  margin-left: 5px;
  border-radius: 6px;
  border: 1px solid var(--cinza);
  background: #fff;
  cursor: pointer;
  transition: transform 0.1s ease, background 0.2s ease;
}

.menu-item button:hover {
  background: #eee;
  transform: scale(1.2);
}

.edit-container input {
  padding: 4px 6px;
  border-radius: 6px;
  border: 1px solid var(--cinza);
  font-size: 14px;
  width: 150px;
}

#diaMenu {
  max-width: 200px;
  padding: 6px;
  border-radius: 6px;
  border: 1px solid var(--cinza);
  margin-bottom: 10px;
}

.historico-card {
  background: #f9f9f9;
  border-radius: 10px;
  padding: 12px;
  margin: 8px 0;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.historico-data {
  font-weight: bold;
  margin-bottom: 6px;
  color: #c62828;
}

.historico-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 0;
  border-bottom: 1px solid #eee;
}

.historico-item:last-child {
  border-bottom: none;
}

.tipo-refeicao {
  padding: 2px 6px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: bold;
  color: white;
}

.tipo-pequeno_almoco { background: #ffb74d; }
.tipo-almoco { background: #4fc3f7; }
.tipo-jantar { background: #81c784; }
.tipo-dieta { background: #ba68c8; }

.status-ativa { color: green; font-weight: bold; }
.status-cancelada { color: red; font-weight: bold; }

.aluno-card {
  background: #f9f9f9;
  padding: 10px;
  border-radius: 8px;
  margin: 6px 0;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  cursor: pointer;
  transition: transform 0.1s ease, box-shadow 0.2s ease;
}

.aluno-card:hover {
  transform: scale(1.02);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.aluno-saldo-card {
  background: #f9f9f9;
  padding: 10px;
  border-radius: 8px;
  margin: 6px 0;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.aluno-saldo-card:hover {
  transform: scale(1.02);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.btn-aluno-actions {
  margin-left: 10px;
  font-size: 12px;
  padding: 4px 8px;
}

</style>
</head>

<body>

<!-- LOGIN -->
<div class="container" id="login">
  <h1>üçΩÔ∏è Cantina</h1>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button class="btn-full" id="btnLogin">Login</button>
</div>

<!-- MENU PRINCIPAL -->
<div class="container hidden" id="menuSelect">
  <h2 id="menuTitle"></h2>
  <div id="buttons"></div>
  <div id="saldo"></div>
  <button class="btn-full" onclick="logout()">Sair</button>
</div>

<!-- CANTINA -->
      <!-- Criar Menu -->
<div class="container hidden" id="cantinaMenu">
  <h2>Criar Menu</h2>
  <input id="dataMenu" type="date">
  <input id="pratoMenu" placeholder="Prato (somente almo√ßo)">
  <select id="tipoMenu">
    <option value="pequeno_almoco">ü•ê Pequeno-almo√ßo</option>
    <option value="almoco">üçΩÔ∏è Almo√ßo</option>
    <option value="jantar">üç≤ Jantar</option>
    <option value="dieta">ü•ó Dieta</option>
  </select>
  <button class="btn-full" id="btnAddMenu">Adicionar Menu</button>
</div>

      <!-- Menus Criados -->
<div class="container hidden" id="cantinaMenus">
  <h2>Menus Criados</h2>

  <label for="diaMenu">Escolhe o dia:</label>
  <input type="date" id="diaMenu">

  <div id="listaMenus"></div>
</div>

      <!-- Reservas do Dia -->
<div id="cantinaReservas" class="container hidden">
  <h2>Reservas do dia</h2>

  <div id="reservasDia"></div>
  <button class="btn-full" onclick="showCantinaReservasHoje()">Reservas do Dia</button>

</div>

      <!-- Hist√≥rico -->
<div class="container hidden" id="cantinaHistorico">
  <h2>Hist√≥rico de Reservas por Aluno</h2>
  <div id="historico"></div>

  <button class="btn-full" id="btnHistorico">Atualizar Hist√≥rico</button>
</div>

      <!-- Saldos -->
<div class="container hidden" id="cantinaSaldos">
  <h2>Saldos em d√≠vida</h2>

  <!-- Cont√™iner dos saldos por aluno -->
  <div id="saldos"></div>

  <!-- Bot√µes para exportar Excel -->
  <div style="margin-top: 15px;">
    <button id="btnDownloadTodos">üì• Excel alunos + saldos</button>
    <button id="btnDownloadHistorico">üì• Excel aluno + hist√≥rico + saldos</button>
  </div>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="js/app.js"></script>
</div>

<!-- ALUNO -->
<div class="container hidden" id="alunoMenu">
  <h2>Reservar Menu</h2>

  <div>
    <label>Filtrar por tipo:</label>
    <select id="filtroTipoAluno" onchange="showAlunoMenu()">
      <option value="">Todos</option>
      <option value="pequeno_almoco">ü•ê Pequeno-almo√ßo</option>
      <option value="almoco">üçΩÔ∏è Almo√ßo</option>
      <option value="jantar">üç≤ Jantar</option>
      <option value="dieta">ü•ó Dieta</option>
    </select>
  </div>

  <div id="listaAlunoMenu"></div>
</div>

<div class="container hidden" id="alunoReservas">
  <h2>Minhas Reservas</h2>
  <div id="minhasReservas"></div>
</div>

<script>

/* ==============================
   CONFIGURA√á√ÉO SUPABASE
============================== */
const SUPABASE_URL = "https://fghsgknistganzbuxrjt.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZnaHNna25pc3RnYW56YnV4cmp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNDUzNjcsImV4cCI6MjA4MzgyMTM2N30.6NPsu-DeQuEpjnHptdZTgsYmtx7mQ5STs8zbwYgIoYY";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let role = null;

/* ==============================
   ELEMENTOS HTML
============================== */
const getEl = id => document.getElementById(id);

const elements = {
  login: getEl("login"),
  email: getEl("email"),
  password: getEl("password"),
  btnLogin: getEl("btnLogin"),
  menuSelect: getEl("menuSelect"),
  menuTitle: getEl("menuTitle"),
  buttons: getEl("buttons"),
  saldoAluno: getEl("saldo"),
  dataMenu: getEl("dataMenu"),
  pratoMenu: getEl("pratoMenu"),
  tipoMenu: getEl("tipoMenu"),
  diaMenu: getEl("diaMenu"),
  listaMenus: getEl("listaMenus"),
  listaAlunoMenu: getEl("listaAlunoMenu"),
  minhasReservas: getEl("minhasReservas"),
  filtroAluno: getEl("filtroAluno"),
  saldos: getEl("saldos"),
  historico: getEl("historico")
};

/* ==============================
   FUN√á√ïES UTILIT√ÅRIAS
============================== */
const show = id => {
  document.querySelectorAll(".container").forEach(c => c.classList.add("hidden"));
  getEl(id).classList.remove("hidden");
};

const addBack = id => {
  const container = getEl(id);
  if(container.querySelector(".btn-back")) return;
  const btn = document.createElement("button");
  btn.className = "btn-back";
  btn.textContent = "Voltar";
  btn.onclick = menu;
  container.appendChild(btn);
};

const tipoEmoji = tipo => {
  const map = {
    pequeno_almoco: 'ü•ê',
    almoco: 'üçΩÔ∏è',
    jantar: 'üç≤',
    dieta: 'ü•ó'
  };
  return map[tipo] || '';
};

const formatCurrency = valor => `‚Ç¨${Number(valor).toFixed(2)}`;

/* ==============================
   LOGIN / LOGOUT
============================== */
async function login(){
  const email = elements.email.value.trim().toLowerCase();
  const password = elements.password.value;

  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if(error){ alert("Erro login: " + error.message); return; }

  currentUser = data.user;

  // Verifica role
  const { data: aluno } = await supabaseClient.from("alunos").select("*").eq("email", email);
  if(aluno.length){ role = "aluno"; menu(); return; }

  const { data: cantina } = await supabaseClient.from("cantina").select("*").eq("email", email);
  if(cantina.length){ role = "cantina"; menu(); return; }

  alert("Utilizador autenticado mas n√£o existe em aluno/cantina");
}

async function logout(){
  await supabaseClient.auth.signOut();
  location.reload();
}

elements.btnLogin.addEventListener("click", login);
document.addEventListener("keydown", e => {
  if(e.key==="Enter" && !elements.login.classList.contains("hidden")) login();
});

/* ==============================
   MENU PRINCIPAL
============================== */
async function menu(){
  show("menuSelect");
  elements.buttons.innerHTML = "";
  elements.menuTitle.innerText = role==="aluno" ? "√Årea do Aluno" : "√Årea da Cantina";

  if(role==="aluno"){
    elements.buttons.innerHTML += `
      <button class="btn-full" onclick="showAlunoMenu()">Reservar Menu</button>
      <button class="btn-full" onclick="showAlunoReservas()">Minhas Reservas</button>
    `;
    await saldo();
  } else {
    elements.buttons.innerHTML += `
      <button class="btn-full" onclick="showCantinaMenu()">Criar Menu</button>
      <button class="btn-full" onclick="showCantinaMenus()">Menus Criados</button>
      <button class="btn-full" onclick="showCantinaReservasHoje()">Reservas do Dia</button>
      <button class="btn-full" onclick="showCantinaHistorico()">Hist√≥rico</button>
      <button class="btn-full" onclick="showCantinaSaldos()">Saldos</button>
    `;
  }
}

/* ==============================
   SALDO ALUNO
============================== */
async function saldo(){
  if(role!=="aluno") return;

  const { data: aluno } = await supabaseClient.from("alunos").select("id").eq("email", currentUser.email).single();
  const { data: reservas } = await supabaseClient.from("reservas")
    .select("preco")
    .eq("aluno_id", aluno.id)
    .eq("cancelada", false);

  const total = reservas.reduce((sum,r) => sum + Number(r.preco), 0);
  elements.saldoAluno.innerText = `Saldo: ${formatCurrency(total)}`;
}

/* =============================
   CANTINA ‚Äî CRIAR MENU
============================= */
function showCantinaMenu(){
  show("cantinaMenu");
  addBack("cantinaMenu");

  // Garantir listener sempre atrelado
  const btn = getEl("btnAddMenu");
  if(btn) {
    btn.onclick = addMenu;
  }
}

async function addMenu(){
  const dataValue = elements.dataMenu.value;
  const tipo = elements.tipoMenu.value;
  let prato = elements.pratoMenu.value.trim();

  const refeicoes = {
    pequeno_almoco: { preco: 2, pratoFixo: "P√£o e Leite" },
    almoco: { preco: 4, pratoFixo: null },
    jantar: { preco: 4, pratoFixo: "" },
    dieta: { preco: 4, pratoFixo: "" }
  };

  if(!refeicoes[tipo]){ alert("Tipo de refei√ß√£o inv√°lido"); return; }
  if(tipo==="pequeno_almoco" && !prato) prato = refeicoes.pequeno_almoco.pratoFixo;
  if(tipo==="almoco" && !prato){ alert("Preenche o prato do almo√ßo"); return; }
  if(!dataValue){ alert("Seleciona uma data"); return; }

  const { data: menuCriado, error } = await supabaseClient.from("menus")
    .insert({ data: dataValue, tipo, prato, preco: refeicoes[tipo].preco })
    .select()
    .single();

  if(error){ alert(error.message); return; }

  alert("Menu adicionado com sucesso!");
  elements.dataMenu.value = "";
  elements.pratoMenu.value = "";
  elements.tipoMenu.value = "pequeno_almoco";

  // Atualiza lista de menus criados
  showCantinaMenus();
}

/* =============================
   CANTINA ‚Äî LISTAR MENUS CRIADOS
============================= */
function toggleDia(data){
  const el = document.getElementById(`dia-${data}`);
  if (el) el.classList.toggle("hidden");
}

async function showCantinaMenus(){
  show("cantinaMenus");
  addBack("cantinaMenus");

  const { data: menus, error } = await supabaseClient
    .from("menus")
    .select("*")
    .order("data", { ascending: true })
    .order("tipo", { ascending: true });

  if (error) {
    alert(error.message);
    return;
  }

  if (!menus || menus.length === 0) {
    listaMenus.innerHTML = "<i>N√£o existem menus criados.</i>";
    return;
  }

  // Agrupar menus por data
  const menusPorDia = {};
  menus.forEach(m => {
    if (!menusPorDia[m.data]) menusPorDia[m.data] = [];
    menusPorDia[m.data].push(m);
  });

  const hoje = new Date().toISOString().split("T")[0];

  listaMenus.innerHTML = Object.entries(menusPorDia)
    .map(([data, menusDia]) => `
      <div class="menu-dia">
        <h3 style="cursor:pointer" onclick="toggleDia('${data}')">
          üìÖ ${data}
        </h3>

        <div id="dia-${data}" class="hidden">
          ${menusDia.map(m => {
            const podeEditar = m.data > hoje;
            return `
              <div class="menu-item">
                <div>
                  ${tipoEmoji(m.tipo)} <b>${m.tipo}</b>
                  ${m.prato ? "‚Äî " + m.prato : ""}
                  (‚Ç¨${m.preco})
                </div>

                ${podeEditar ? `
                  <div>
                    <button onclick="startEdit('${m.id}')">‚úèÔ∏è</button>
                    <button onclick="apagarMenu('${m.id}')">üóëÔ∏è</button>
                  </div>
                ` : `<small>‚õî passado</small>`}
              </div>

              <div id="edit-${m.id}" class="hidden" style="margin-bottom:10px;">
                <input id="input-prato-${m.id}" value="${m.prato || ""}">
                <button onclick="saveEdit('${m.id}')">üíæ</button>
                <button onclick="cancelEdit('${m.id}')">‚ùå</button>
              </div>
            `;
          }).join("")}
        </div>
      </div>
    `)
    .join("");
}

/* =============================
   CANTINA ‚Äî EDITAR/EXCLUIR MENU
============================= */
function startEdit(id){ getEl(`edit-${id}`).classList.remove('hidden'); }
function cancelEdit(id){ getEl(`edit-${id}`).classList.add('hidden'); }

async function saveEdit(id){
  const novoPrato = getEl(`input-prato-${id}`).value.trim();
  if(!novoPrato){ alert("O prato n√£o pode estar vazio"); return; }
  await supabaseClient.from("menus").update({ prato: novoPrato }).eq("id", id);
  showCantinaMenus();
}

async function apagarMenu(id){
  if(!confirm("Tens a certeza que queres apagar este menu?")) return;
  await supabaseClient.from("menus").delete().eq("id", id);
  showCantinaMenus();
}

/* =============================
   CANTINA ‚Äî RESERVAS
============================= */
async function showCantinaReservasHoje(){
  show("cantinaReservas");
  addBack("cantinaReservas");

  const hoje = new Date().toISOString().slice(0,10);
  const div = document.getElementById("reservasDia");

  div.innerHTML = "A carregar reservas de hoje...";

  const { data, error } = await supabaseClient
      .from("reservas")
      .select(`
         id,
          tipo,
         alunos(nome)
  `)
     .eq("data", hoje)
     .eq("cancelada", false);

  if (error) {
    div.innerHTML = error.message;
    return;
  }

  const contagem = {
    pequeno_almoco: 0,
    almoco: 0,
    jantar: 0,
    dieta: 0
  };

  data.forEach(r => {
    if (contagem[r.tipo] !== undefined) {
      contagem[r.tipo]++;
    }
  });

  div.innerHTML = `
    <div class="refeicao" onclick="verDetalheRefeicao('pequeno_almoco')">
      ‚òï Pequeno-almo√ßo ‚Äî ${contagem.pequeno_almoco}
    </div>
    <div class="refeicao" onclick="verDetalheRefeicao('almoco')">
      üçΩÔ∏è Almo√ßo ‚Äî ${contagem.almoco}
    </div>
    <div class="refeicao" onclick="verDetalheRefeicao('jantar')">
      üåô Jantar ‚Äî ${contagem.jantar}
    </div>
    <div class="refeicao" onclick="verDetalheRefeicao('dieta')">
      ü•ó Dieta ‚Äî ${contagem.dieta}
    </div>
  `;
}

// Por refei√ß√£o
async function verDetalheRefeicao(tipo){
  const hoje = new Date().toISOString().slice(0,10);
  const div = document.getElementById("reservasDia");

  div.innerHTML = "A carregar alunos...";

  const { data, error } = await supabaseClient
    .from("reservas")
    .select("alunos ( nome )")
    .eq("data", hoje)
    .eq("tipo", tipo);

  if (error) {
    div.innerHTML = error.message;
    return;
  }

  if (data.length === 0) {
    div.innerHTML = "Sem reservas";
    return;
  }

  div.innerHTML = `
    <h3>${tipo.toUpperCase()}</h3>
    ${data.map(r => `<div>${r.alunos.nome}</div>`).join("")}
  `;
}

/* =============================
   CANTINA ‚Äî HIST√ìRICO
============================= */
async function showCantinaHistorico(){
  show("cantinaHistorico");
  addBack("cantinaHistorico");

  const div = document.getElementById("historico");
  div.innerHTML = "A carregar alunos...";

  const { data: alunos, error } = await supabaseClient
    .from("alunos")
    .select("id, nome")
    .order("nome", { ascending: true });

  if(error){ div.innerHTML = "Erro: " + error.message; return; }

  if(!alunos || alunos.length===0){
    div.innerHTML = "<i>Sem alunos cadastrados.</i>";
    return;
  }

  div.innerHTML = alunos.map(a => `
    <div class="aluno-card" onclick="showHistoricoAluno('${a.id}')">
      üë§ ${a.nome}
    </div>
  `).join("");
}

async function showHistoricoAluno(alunoId){
  const div = document.getElementById("historico");
  div.innerHTML = "A carregar hist√≥rico...";

  const { data, error } = await supabaseClient
    .from("reservas")
    .select(`
      id,
      tipo,
      data,
      cancelada,
      preco,
      menus!inner(prato)
    `)
    .eq("aluno_id", alunoId)
    .order("data", { ascending: false });

  if(error){ div.innerHTML = "Erro: " + error.message; return; }

  if(!data || data.length===0){
    div.innerHTML = "<i>Sem hist√≥rico dispon√≠vel para este aluno.</i>";
    return;
  }

  // Agrupa por data
  const grouped = {};
  data.forEach(r => {
    if(!grouped[r.data]) grouped[r.data] = [];
    grouped[r.data].push(r);
  });

  div.innerHTML = Object.keys(grouped).sort((a,b)=>b.localeCompare(a)).map(d => {
    const items = grouped[d].map(r => `
      <div class="historico-item">
        <div>
          üçΩÔ∏è <span class="tipo-refeicao tipo-${r.tipo}">${r.tipo.replace("_"," ")}</span> ‚Äî ${r.menus?.prato || "-"}<br>
          üí∞ ‚Ç¨${r.preco.toFixed(2)}
        </div>
        <div class="${r.cancelada ? 'status-cancelada' : 'status-ativa'}">
          ${r.cancelada ? '‚ùå Cancelada' : '‚úÖ Ativa'}
        </div>
      </div>
    `).join("");

    return `
      <div class="historico-card">
        <div class="historico-data">üìÖ ${d}</div>
        ${items}
      </div>
    `;
  }).join("");
}

/* =============================
   CANTINA ‚Äî SALDOS
============================= */
/* ====================== SALDOS ====================== */
async function showCantinaSaldos(){
  show("cantinaSaldos");

  const { data, error } = await supabaseClient
    .from("reservas")
    .select(`preco, aluno_id, alunos!inner(nome)`)
    .eq("cancelada", false);

  if(error){ alert(error.message); return; }

  // Agrega saldo por aluno
  const saldos = {};
  data.forEach(r => {
    const a = r.alunos;
    if(!saldos[a.id]) saldos[a.id] = { nome: a.nome, total: 0 };
    saldos[a.id].total += Number(r.preco);
  });

  const div = document.getElementById("saldos");
  div.innerHTML = Object.keys(saldos).length === 0
    ? "<i>Sem saldos em d√≠vida.</i>"
    : Object.keys(saldos).map(alunoId => {
        const a = saldos[alunoId];
        return `
          <div class="aluno-saldo-card" onclick="showAlunoSaldoDetalhe('${alunoId}')">
            <span>üë§ ${a.nome}</span>
            <span>‚Ç¨${a.total.toFixed(2)}</span>
          </div>
        `;
      }).join("");
}

/* Drill-down: download Excel ou liquidar d√≠vida */
async function showAlunoSaldoDetalhe(alunoId){
  const { data: aluno } = await supabaseClient
    .from("alunos")
    .select("nome")
    .eq("id", alunoId)
    .single();
  if(!aluno) return alert("Aluno n√£o encontrado");

  const { data: reservas } = await supabaseClient
    .from("reservas")
    .select("preco")
    .eq("aluno_id", alunoId)
    .eq("cancelada", false);

  const total = reservas.reduce((s,r)=>s+Number(r.preco),0);

  const confirmOptions = confirm(`Aluno: ${aluno.nome}\nSaldo em d√≠vida: ‚Ç¨${total.toFixed(2)}\n\nDeseja: OK ‚Üí Baixar Excel hist√≥rico, Cancel ‚Üí Liquidar d√≠vida?`);

  if(confirmOptions){
    downloadExcelAluno(alunoId);
  } else {
    liquidarDividaAluno(alunoId);
  }
}

/* Download hist√≥rico Excel de um aluno */
async function downloadExcelAluno(alunoId){
  const { data: reservas } = await supabaseClient
    .from("reservas")
    .select(`data, tipo, preco, cancelada, menus!inner(prato)`)
    .eq("aluno_id", alunoId)
    .order("data", { ascending: true });

  const rows = reservas.map(r => ({
    Data: r.data,
    Tipo: r.tipo,
    Prato: r.menus?.prato || "-",
    Preco: r.preco,
    Status: r.cancelada ? "Cancelada" : "Ativa"
  }));

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "Hist√≥rico");
  XLSX.writeFile(wb, `Historico_Aluno_${alunoId}.xlsx`);
}

/* Liquidar d√≠vida do aluno */
async function liquidarDividaAluno(alunoId){
  if(!confirm("Tem certeza que quer apagar todo o hist√≥rico deste aluno? Esta a√ß√£o √© irrevers√≠vel!")) return;

  await supabaseClient.from("reservas").delete().eq("aluno_id", alunoId);

  alert("Hist√≥rico apagado com sucesso!");
  showCantinaSaldos();
}

/* Exportar Excel: todos os alunos (somente saldo) */
document.getElementById("btnDownloadTodos").addEventListener("click", async () => {
  const { data } = await supabaseClient
    .from("reservas")
    .select(`preco, alunos!inner(nome)`)
    .eq("cancelada", false);

  const aggregated = {};
  data.forEach(r => {
    const nome = r.alunos.nome;
    if(!aggregated[nome]) aggregated[nome] = 0;
    aggregated[nome] += r.preco;
  });

  const rows = Object.keys(aggregated).map(nome => ({
    Aluno: nome,
    Saldo: aggregated[nome]
  }));

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "Saldos");
  XLSX.writeFile(wb, "Saldos_Todos_Alunos.xlsx");
});

/* Exportar Excel completo: todos os alunos + hist√≥rico */
document.getElementById("btnDownloadHistorico").addEventListener("click", async () => {
  const { data } = await supabaseClient
    .from("reservas")
    .select(`aluno_id, alunos!inner(nome), data, tipo, preco, cancelada, menus!inner(prato)`)
    .order("data", { ascending: true });

  const rows = data.map(r => ({
    Aluno: r.alunos.nome,
    Data: r.data,
    Tipo: r.tipo,
    Prato: r.menus?.prato || "-",
    Preco: r.preco,
    Status: r.cancelada ? "Cancelada" : "Ativa"
  }));

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "Hist√≥rico Completo");
  XLSX.writeFile(wb, "Historico_Complete_Alunos.xlsx");
});

/* ==============================
   ALUNO ‚Äî LISTAR MENU E RESERVAR
============================== */
async function showAlunoMenu(){
  const filtroTipo = document.getElementById("filtroTipoAluno")?.value || "";
  show("alunoMenu"); addBack("alunoMenu");

  const { data: aluno } = await supabaseClient.from("alunos").select("id").eq("email", currentUser.email).single();
  const { data: menus } = await supabaseClient.from("menus").select("*").order("data",{ascending:true});
  const { data: reservas } = await supabaseClient.from("reservas")
    .select("id,menu_id,tipo,data,cancelada")
    .eq("aluno_id", aluno.id);

  const reservasMap = {}; reservas.forEach(r=>reservasMap[r.menu_id]=r);
  const hojeStr = new Date().toISOString().split("T")[0];
  const hora = new Date().getHours();
  const minuto = new Date().getMinutes();

  elements.listaAlunoMenu.innerHTML = menus
    .filter(m => m.tipo!=="almoco")
    .filter(m => {
      if(filtroTipo && m.tipo!==filtroTipo) return false;
      const r = reservasMap[m.id];
      if(r && !r.cancelada) return false;

      const menuDataStr = new Date(m.data).toISOString().split("T")[0];
      if(m.tipo==="pequeno_almoco" && (menuDataStr<hojeStr || (menuDataStr===hojeStr && (hora>9||(hora===9 && minuto>=30))))) return false;
      if(m.tipo==="jantar" && (menuDataStr<hojeStr || (menuDataStr===hojeStr && hora>=12))) return false;
      if(m.tipo==="dieta"){
        const almocoCancelado = reservas.find(r=>r.tipo==="almoco" && r.data===menuDataStr && r.cancelada);
        if(!almocoCancelado) return false;
      }
      return true;
    })
    .map(m=>`
      <div class="menu">
        <b>${m.tipo}</b> ‚Äî ${m.data} ${m.prato? "- "+m.prato:""} (${formatCurrency(m.preco)})
        <br>
        <button class="btn-reservar" data-id="${m.id}" data-tipo="${m.tipo}" data-preco="${m.preco}" data-data="${m.data}">Reservar</button>
      </div>
    `).join("");

  document.querySelectorAll(".btn-reservar").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      await reservarMenu(btn.dataset.id, parseFloat(btn.dataset.preco), btn.dataset.data, btn.dataset.tipo);
    });
  });

  await saldo();
}

async function reservarMenu(menuId, preco, data, tipo){
  const { data: aluno } = await supabaseClient.from("alunos").select("id").eq("email", currentUser.email).single();

  if(tipo==="dieta"){
    const { data: almocoAtivo } = await supabaseClient.from("reservas")
      .select("*")
      .eq("aluno_id", aluno.id)
      .eq("tipo","almoco")
      .eq("data",data)
      .eq("cancelada",false);

    if(almocoAtivo.length>0){ alert("S√≥ podes reservar Dieta se cancelares o almo√ßo do mesmo dia"); return; }
  }

  await supabaseClient.from("reservas").insert({
    aluno_id: aluno.id,
    menu_id: menuId,
    preco,
    data,
    tipo,
    cancelada:false
  });

  alert("Reserva efetuada!");
  showAlunoMenu(); showAlunoReservas(); saldo();
}

/* ==============================
   ALUNO ‚Äî MINHAS RESERVAS
============================== */
async function showAlunoReservas(){
  show("alunoReservas"); addBack("alunoReservas");

  const { data: aluno } = await supabaseClient.from("alunos").select("id").eq("email", currentUser.email).single();
  const { data: reservas } = await supabaseClient.from("reservas")
    .select("id,data,tipo,preco,cancelada,menus!inner(prato)")
    .eq("aluno_id", aluno.id)
    .order("data",{ascending:true});

  const agora = new Date(); const hojeStr = agora.toISOString().split("T")[0]; const hora = agora.getHours(); const minuto = agora.getMinutes();

  elements.minhasReservas.innerHTML = reservas.map(r=>{
    let podeCancelar = false;
    if(!r.cancelada){
      const rDataStr = new Date(r.data).toISOString().split("T")[0];
      if(r.tipo==="pequeno_almoco"){ if(rDataStr>hojeStr) podeCancelar=true; else if(rDataStr===hojeStr && (hora<9||(hora===9 && minuto<30))) podeCancelar=true; }
      if(r.tipo==="almoco"){ if(rDataStr>hojeStr) podeCancelar=true; else if(rDataStr===hojeStr && hora<9) podeCancelar=true; }
      if(r.tipo==="jantar"){ if(rDataStr>hojeStr) podeCancelar=true; else if(rDataStr===hojeStr && hora<12) podeCancelar=true; }
      if(r.tipo==="dieta") podeCancelar=false;
    }
    return `
      <div class="menu">
        <b>${r.tipo}</b> ‚Äî ${r.data} ${r.menus?.prato? "- "+r.menus.prato:""} (${formatCurrency(r.preco)})<br>
        ${r.cancelada? "‚ùå Cancelada":""}
        ${podeCancelar? `<button class="btn-cancelar" data-id="${r.id}">Cancelar</button>`:(!r.cancelada? "‚õî Cancelamento indispon√≠vel":"")}
      </div>
    `;
  }).join("");

  document.querySelectorAll(".btn-cancelar").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      await supabaseClient.from("reservas").update({ cancelada:true }).eq("id",btn.dataset.id);
      showAlunoReservas(); saldo();
    });
  });

  await saldo();
}

</script>

</body>
</html>